generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Multi-tenancy ───────────────────────────────────────────────

model Tenant {
  id        String   @id @default(cuid())
  name      String
  domain    String?  @unique
  settings  Json     @default("{}")
  plan      String   @default("starter")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users               User[]
  vendors              Vendor[]
  consultants          Consultant[]
  jobs                 Job[]
  submissions          Submission[]
  consentRecords       ConsentRecord[]
  interviews           Interview[]
  placements           Placement[]
  timesheets           Timesheet[]
  invoices             Invoice[]
  payments             Payment[]
  immigrationCases     ImmigrationCase[]
  complianceDocuments  ComplianceDocument[]
  agentAuditLogs       AgentAuditLog[]
  trustEvents          TrustEvent[]
  notifications        Notification[]
}

// ─── Users & Auth ────────────────────────────────────────────────

enum UserRole {
  MANAGEMENT
  CONSULTANT
  RECRUITMENT
  SALES
  HR
  IMMIGRATION
  ACCOUNTS
  SUPERADMIN
}

model User {
  id            String    @id @default(cuid())
  tenantId      String
  email         String
  passwordHash  String
  firstName     String
  lastName      String
  role          UserRole
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant        Tenant    @relation(fields: [tenantId], references: [id])
  consultant    Consultant?

  notifications    Notification[]
  approvedTimesheets Timesheet[] @relation("TimesheetApprover")

  @@unique([tenantId, email])
  @@index([tenantId])
}

// ─── Vendors / Clients ───────────────────────────────────────────

enum MsaStatus {
  PENDING
  ACTIVE
  EXPIRED
  TERMINATED
}

model Vendor {
  id               String    @id @default(cuid())
  tenantId         String
  companyName      String
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  paymentTermsDays Int       @default(30)
  msaStatus        MsaStatus @default(PENDING)
  w9Received       Boolean   @default(false)
  insuranceVerified Boolean  @default(false)

  // Trust metrics (computed by TrustGraphAgent)
  trustScore         Float?
  paySpeedDays       Float?
  ghostRate          Float?
  disputeFrequency   Float?
  feedbackLatencyHrs Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  jobs       Job[]
  invoices   Invoice[]
  placements Placement[]

  @@index([tenantId])
}

// ─── Consultants ─────────────────────────────────────────────────

enum VerificationStatus {
  UNVERIFIED
  PARTIAL
  VERIFIED
  FLAGGED
}

model Consultant {
  id                    String             @id @default(cuid())
  tenantId              String
  userId                String?            @unique
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  skills                Json               @default("[]")
  resumeUrl             String?
  visaStatus            String?
  workAuthExpiry        DateTime?
  availableFrom         DateTime?
  desiredRate           Float?
  currentRate           Float?
  verificationStatus    VerificationStatus @default(UNVERIFIED)
  verificationChecklist Json               @default("[]")
  consentPolicy         Json               @default("{}")
  trustScore            Float?
  performanceHistory    Json               @default("[]")
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  user             User?             @relation(fields: [userId], references: [id])
  submissions      Submission[]
  consentRecords   ConsentRecord[]
  placements       Placement[]
  timesheets       Timesheet[]
  immigrationCases ImmigrationCase[]

  @@index([tenantId])
  @@index([tenantId, email])
}

// ─── Jobs ────────────────────────────────────────────────────────

enum JobStatus {
  DRAFT
  OPEN
  ON_HOLD
  FILLED
  CANCELLED
}

enum LocationType {
  REMOTE
  HYBRID
  ONSITE
}

enum RateType {
  HOURLY
  ANNUAL
}

model Job {
  id                      String       @id @default(cuid())
  tenantId                String
  vendorId                String
  title                   String
  description             String
  structuredRequirements  Json         @default("{}")
  skills                  Json         @default("[]")
  location                String?
  locationType            LocationType @default(REMOTE)
  rateMin                 Float?
  rateMax                 Float?
  rateType                RateType     @default(HOURLY)
  startDate               DateTime?
  durationMonths          Int?
  status                  JobStatus    @default(DRAFT)

  // Job Truth metrics (computed)
  closureLikelihood Float?
  interviewSpeed    Float?
  rateHonesty       Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  vendor      Vendor       @relation(fields: [vendorId], references: [id])
  submissions Submission[]
  placements  Placement[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, vendorId])
}

// ─── Submissions ─────────────────────────────────────────────────

enum SubmissionStatus {
  DRAFT
  PENDING_CONSENT
  AWAITING_CONSENT
  SUBMITTED
  SHORTLISTED
  REJECTED
  WITHDRAWN
}

enum SubmitterType {
  USER
  AGENT
}

model Submission {
  id                  String           @id @default(cuid())
  tenantId            String
  jobId               String
  consultantId        String
  submittedById       String?
  submitterType       SubmitterType    @default(USER)
  agentId             String?
  resumeVersion       String?
  resumeHash          String?
  rtrDocUrl           String?
  status              SubmissionStatus @default(DRAFT)
  vendorFeedback      String?
  feedbackReceivedAt  DateTime?
  duplicateCheckResult Json?
  notes               String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  job            Job             @relation(fields: [jobId], references: [id])
  consultant     Consultant      @relation(fields: [consultantId], references: [id])
  consentRecord  ConsentRecord?
  interviews     Interview[]

  @@unique([tenantId, jobId, consultantId])
  @@index([tenantId])
}

// ─── Consent Ledger ──────────────────────────────────────────────

enum ConsentType {
  EXPLICIT
  AUTO_POLICY
}

model ConsentRecord {
  id             String      @id @default(cuid())
  tenantId       String
  consultantId   String
  submissionId   String      @unique
  consentType    ConsentType
  consentGivenAt DateTime    @default(now())
  vendorName     String
  jobTitle       String
  rateSubmitted  Float?

  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  consultant  Consultant @relation(fields: [consultantId], references: [id])
  submission  Submission @relation(fields: [submissionId], references: [id])

  @@index([tenantId])
  @@index([tenantId, consultantId])
}

// ─── Interviews ──────────────────────────────────────────────────

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Interview {
  id                  String          @id @default(cuid())
  tenantId            String
  submissionId        String
  scheduledAt         DateTime
  durationMinutes     Int             @default(60)
  interviewType       String?
  status              InterviewStatus @default(SCHEDULED)
  interviewerFeedback String?
  candidateFeedback   String?
  rating              Int?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  submission Submission @relation(fields: [submissionId], references: [id])

  @@index([tenantId])
}

// ─── Placements ──────────────────────────────────────────────────

enum PlacementStatus {
  ACTIVE
  COMPLETED
  TERMINATED
  EXTENDED
}

model Placement {
  id              String          @id @default(cuid())
  tenantId        String
  consultantId    String
  jobId           String
  vendorId        String
  startDate       DateTime
  endDate         DateTime?
  billRate        Float
  payRate         Float
  margin          Float
  status          PlacementStatus @default(ACTIVE)
  retentionDays30 Boolean?
  retentionDays60 Boolean?
  retentionDays90 Boolean?
  extensionCount  Int             @default(0)
  placementDna    Json            @default("{}")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  consultant Consultant  @relation(fields: [consultantId], references: [id])
  job        Job         @relation(fields: [jobId], references: [id])
  vendor     Vendor      @relation(fields: [vendorId], references: [id])
  timesheets Timesheet[]

  @@index([tenantId])
}

// ─── Timesheets ──────────────────────────────────────────────────

enum TimesheetStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  INVOICED
}

model Timesheet {
  id            String          @id @default(cuid())
  tenantId      String
  placementId   String
  consultantId  String
  weekEnding    DateTime
  hoursRegular  Float           @default(0)
  hoursOvertime Float           @default(0)
  status        TimesheetStatus @default(DRAFT)
  approvedById  String?
  approvedAt    DateTime?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  placement  Placement  @relation(fields: [placementId], references: [id])
  consultant Consultant @relation(fields: [consultantId], references: [id])
  approvedBy User?      @relation("TimesheetApprover", fields: [approvedById], references: [id])

  @@unique([tenantId, placementId, weekEnding])
  @@index([tenantId])
}

// ─── Invoices ────────────────────────────────────────────────────

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  DISPUTED
}

model Invoice {
  id            String        @id @default(cuid())
  tenantId      String
  vendorId      String
  invoiceNumber String
  periodStart   DateTime
  periodEnd     DateTime
  totalAmount   Float
  status        InvoiceStatus @default(DRAFT)
  sentAt        DateTime?
  dueDate       DateTime?
  paidAt        DateTime?
  paidAmount    Float?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  vendor   Vendor    @relation(fields: [vendorId], references: [id])
  payments Payment[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId])
}

// ─── Payments ────────────────────────────────────────────────────

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

model Payment {
  id              String        @id @default(cuid())
  tenantId        String
  invoiceId       String
  amount          Float
  paymentDate     DateTime?
  paymentMethod   String?
  referenceNumber String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  invoice Invoice @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
}

// ─── Immigration ─────────────────────────────────────────────────

enum ImmigrationCaseStatus {
  INITIATED
  FILED
  PENDING
  APPROVED
  DENIED
  EXPIRED
  RFE
}

model ImmigrationCase {
  id           String                @id @default(cuid())
  tenantId     String
  consultantId String
  caseType     String
  status       ImmigrationCaseStatus @default(INITIATED)
  filingDate   DateTime?
  expiryDate   DateTime?
  milestones   Json                  @default("[]")
  constraints  Json                  @default("{}")
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  tenant     Tenant     @relation(fields: [tenantId], references: [id])
  consultant Consultant @relation(fields: [consultantId], references: [id])

  @@index([tenantId])
  @@index([tenantId, consultantId])
}

// ─── Compliance ──────────────────────────────────────────────────

enum ComplianceDocStatus {
  PENDING
  VERIFIED
  EXPIRED
  REJECTED
}

model ComplianceDocument {
  id           String            @id @default(cuid())
  tenantId     String
  entityType   String
  entityId     String
  documentType String
  fileUrl      String
  uploadedAt   DateTime          @default(now())
  expiresAt    DateTime?
  verifiedById String?
  verifiedAt   DateTime?
  status       ComplianceDocStatus @default(PENDING)

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([tenantId, entityType, entityId])
}

// ─── Agent Audit Log (immutable) ─────────────────────────────────

model AgentAuditLog {
  id         String   @id @default(cuid())
  tenantId   String
  agentRole  String
  agentId    String
  action     String
  toolCalled String
  input      Json     @default("{}")
  output     Json     @default("{}")
  reason     String?
  workflowId String?
  durationMs Int?
  status     String   @default("success")
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId, createdAt])
  @@index([workflowId])
}

// ─── Trust Events ────────────────────────────────────────────────

model TrustEvent {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  eventType  String
  score      Float?
  delta      Float?
  reason     String?
  metadata   Json     @default("{}")
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])

  // Polymorphic: entityType + entityId references Vendor, Consultant, or User
  // Resolved at application layer, not via FK constraints
  @@index([tenantId, entityType, entityId])
  @@index([tenantId, createdAt])
}

// ─── Notifications ───────────────────────────────────────────────

enum NotificationChannel {
  EMAIL
  SMS
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model Notification {
  id        String             @id @default(cuid())
  tenantId  String
  userId    String
  channel   NotificationChannel @default(IN_APP)
  subject   String
  body      String
  status    NotificationStatus  @default(PENDING)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime           @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId, userId])
}
